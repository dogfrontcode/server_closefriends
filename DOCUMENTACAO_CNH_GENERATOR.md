# üìã Documenta√ß√£o: Sistema de Coordenadas e Gerador de CNH

## üéØ Vis√£o Geral

O sistema de gera√ß√£o de CNH funciona atrav√©s de dois componentes principais:

1. **Sistema de Coordenadas (`coordinates.py`)** - Define onde cada elemento deve ser posicionado na CNH
2. **Gerador de CNH (`cnh_generator.py`)** - Renderiza os elementos na imagem usando as coordenadas

## üó∫Ô∏è Sistema de Coordenadas

### Estrutura Base

O arquivo `static/cnh_matriz/coordinates.py` define a matriz de coordenadas baseada no template oficial da CNH brasileira.

```python
# Dimens√µes do template CNH
TEMPLATE_WIDTH = 700   # pixels
TEMPLATE_HEIGHT = 440  # pixels

# Template base
TEMPLATE_PATH = "static/cnh_matriz/front-cnh.png"
```

### Coordenadas dos Campos

As coordenadas s√£o definidas em formato `(x, y)` onde:
- **x**: Posi√ß√£o horizontal (0 = esquerda, 700 = direita)
- **y**: Posi√ß√£o vertical (0 = topo, 440 = base)

```python
CNH_COORDINATES = {
    "nome_completo": (120.5, 144.5),      # Nome do portador
    "numero_habilitacao": (50, 304),       # N√∫mero da habilita√ß√£o (vertical)
    "data_nascimento": (483, 171),         # Data de nascimento
    "cpf": (315, 305),                     # CPF
    "categoria": (581, 305),               # Categoria (A, B, C, D, E)
    # ... outros campos
}
```

### Configura√ß√µes de Fonte

Cada campo tem suas pr√≥prias configura√ß√µes de fonte:

```python
FONT_CONFIGS = {
    "nome_completo": {"size": 14, "color": (0, 0, 0)},
    "numero_habilitacao": {"size": 12, "color": (0, 0, 0), "bold": True},
    "cpf": {"size": 11, "color": (0, 0, 0)},
    # ... outras configura√ß√µes
}
```

## üèóÔ∏è Gerador de CNH

### Classe Principal: `CNHImageGenerator`

A classe principal que coordena todo o processo de gera√ß√£o:

```python
class CNHImageGenerator:
    # Configura√ß√µes da imagem
    IMAGE_WIDTH = 700
    IMAGE_HEIGHT = 440
    TEXT_COLOR = (0, 0, 0)
    
    # Diret√≥rios
    OUTPUT_DIR = "static/generated_cnhs"
    FONTS_DIR = "static/fonts"
    TEMPLATE_PATH = "static/cnh_matriz/front-cnh.png"
```

### Fluxo Principal de Gera√ß√£o

1. **Inicializa√ß√£o** (`__init__`)
   - Cria diret√≥rios necess√°rios
   - Carrega fontes dispon√≠veis

2. **Gera√ß√£o da CNH** (`generate_basic_cnh`)
   - Carrega template base
   - Aplica dados usando coordenadas
   - Processa foto 3x4
   - Processa assinatura
   - Salva arquivo final

3. **Aplica√ß√£o de Dados** (`_apply_data_with_coordinates`)
   - Itera sobre os campos do CNH request
   - Aplica coordenadas e fontes espec√≠ficas
   - Trata campos especiais (como n√∫mero vertical)

## üé® M√©todos de Renderiza√ß√£o

### Texto Normal
```python
def draw_field_if_exists(field_name, text):
    if field_name in CNH_COORDINATES and field_name in FONT_CONFIGS:
        coord = CNH_COORDINATES[field_name]
        font_config = FONT_CONFIGS[field_name]
        font = self._get_font(font_config["size"], bold=font_config.get("bold", False))
        draw.text(coord, str(text), fill=font_config["color"], font=font)
```

### Texto Rotacionado
```python
def _draw_rotated_text(self, draw, text, position, font, color, rotation=90):
    # Cria imagem tempor√°ria
    # Desenha texto na imagem tempor√°ria
    # Rotaciona a imagem
    # Cola na imagem principal
```

### N√∫mero da Habilita√ß√£o (Caso Especial)
```python
def _draw_numero_habilitacao_vertical(self, draw, numero_text, position):
    # Dimens√µes espec√≠ficas: 23x161 pixels
    # Fonte bold obrigat√≥ria
    # Rota√ß√£o 90¬∞ para ficar vertical
    # Ajuste autom√°tico de tamanho se necess√°rio
```

## üìê Sistema de Coordenadas Detalhado

### √Åreas Principais da CNH

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ CABE√áALHO (0, 0) - REP√öBLICA FEDERATIVA DO BRASIL                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚îÇ FOTO 3x4          ‚îÇ DADOS PESSOAIS                               ‚îÇ
‚îÇ ‚îÇ (121, 180)        ‚îÇ Nome: (120.5, 144.5)                        ‚îÇ
‚îÇ ‚îÇ 169x237px         ‚îÇ Data Nasc: (483, 171)                       ‚îÇ
‚îÇ ‚îÇ                   ‚îÇ CPF: (315, 305)                              ‚îÇ
‚îÇ ‚îÇ                   ‚îÇ Categoria: (581, 305)                       ‚îÇ
‚îú‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇN‚îÇ                   ‚îÇ INFORMA√á√ïES DA HABILITA√á√ÉO                   ‚îÇ
‚îÇ√ö‚îÇ                   ‚îÇ Data Emiss√£o: (317, 223)                     ‚îÇ
‚îÇM‚îÇ                   ‚îÇ Validade: (440, 223)                         ‚îÇ
‚îÇE‚îÇ                   ‚îÇ N¬∫ Registro: (450, 305)                      ‚îÇ
‚îÇR‚îÇ                   ‚îÇ ACC: (579, 213)                               ‚îÇ
‚îÇO‚îÇ                   ‚îÇ                                               ‚îÇ
‚îÇ ‚îÇ                   ‚îÇ FILIA√á√ÉO                                      ‚îÇ
‚îÇ(‚îÇ                   ‚îÇ Pai: (317, 385)                              ‚îÇ
‚îÇ5‚îÇ                   ‚îÇ M√£e: (317, 400)                              ‚îÇ
‚îÇ0‚îÇ                   ‚îÇ                                               ‚îÇ
‚îÇ,‚îÇ                   ‚îÇ ASSINATURA                                    ‚îÇ
‚îÇ3‚îÇ                   ‚îÇ (120, 430) - 168x50px                        ‚îÇ
‚îÇ0‚îÇ                   ‚îÇ                                               ‚îÇ
‚îÇ4‚îÇ                   ‚îÇ                                               ‚îÇ
‚îÇ)‚îÇ                   ‚îÇ                                               ‚îÇ
‚îî‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Coordenadas Cr√≠ticas

#### Foto 3x4
```python
FOTO_3X4_AREA = {
    "position": (121, 180),    # Posi√ß√£o x, y
    "width": 169,              # Largura
    "height": 237              # Altura
}
```

#### Assinatura
```python
ASSINATURA_AREA = {
    "position": (120, 430),    # Posi√ß√£o x, y
    "width": 168,              # Largura
    "height": 50               # Altura
}
```

## üî§ Sistema de Fontes

### Hierarquia de Fontes

1. **Fontes Preferidas** (Google Fonts - Arvo)
   - `Arvo-Bold.ttf` - Para texto em negrito
   - `Arvo-Regular.ttf` - Para texto normal

2. **Fontes do Sistema** (Fallback)
   - macOS: Arial, Helvetica
   - Linux: DejaVu Sans, Liberation Sans
   - Windows: Arial, Calibri

### M√©todo de Carregamento

```python
def _get_font(self, size, bold=False):
    if bold:
        font_candidates = [
            "static/fonts/Arvo-Bold.ttf",
            "static/fonts/Arvo-Regular.ttf",  # fallback
        ]
    else:
        font_candidates = [
            "static/fonts/Arvo-Regular.ttf",
            "static/fonts/Arvo-Bold.ttf",     # fallback
        ]
    
    # Tenta cada fonte da lista
    for font_path in font_candidates:
        try:
            if os.path.exists(font_path):
                font = ImageFont.truetype(font_path, size)
                self._test_font_utf8(font)  # Testa suporte a acentos
                return font
        except Exception:
            continue
    
    # Fallback final
    return ImageFont.load_default()
```

## üéØ Casos Especiais

### N√∫mero da Habilita√ß√£o Vertical

Este √© o caso mais complexo do sistema, pois precisa:

1. **Dimens√µes Espec√≠ficas**: 23px largura √ó 161px altura
2. **Fonte Bold Obrigat√≥ria**
3. **Rota√ß√£o 90¬∞** (texto vertical)
4. **Ajuste Autom√°tico** do tamanho da fonte

#### Algoritmo de Renderiza√ß√£o

```python
def _draw_numero_habilitacao_vertical(self, draw, numero_text, position):
    # 1. Configura√ß√µes iniciais
    x, y = position
    area_width = 23
    area_height = 161
    
    # 2. Carrega fonte bold
    font = self._get_font(font_size, bold=True)
    
    # 3. Mede o texto
    bbox = draw.textbbox((0, 0), numero_text, font=font)
    text_width = bbox[2] - bbox[0]
    text_height = bbox[3] - bbox[1]
    
    # 4. Ajusta fonte se necess√°rio
    while text_width > area_height - 10 and current_font_size > 6:
        current_font_size -= 1
        font = self._get_font(current_font_size, bold=True)
        # Remede o texto...
    
    # 5. Cria imagem tempor√°ria
    temp_img = Image.new('RGBA', (temp_width, temp_height), (255, 255, 255, 0))
    temp_draw = ImageDraw.Draw(temp_img)
    
    # 6. Desenha texto centralizado
    text_x = (temp_width - text_width) // 2
    text_y = (temp_height - text_height) // 2
    temp_draw.text((text_x, text_y), numero_text, font=font, fill=color)
    
    # 7. Rotaciona 90¬∞
    rotated_img = temp_img.rotate(90, expand=True)
    
    # 8. Calcula posi√ß√£o final
    final_x = x - (rotated_img.width - area_width) // 2
    final_y = y + (area_height - rotated_img.height) // 2
    
    # 9. Cola na imagem principal
    draw._image.paste(rotated_img, (final_x, final_y), rotated_img)
```

## üõ†Ô∏è Como Adicionar Novos Campos

### 1. Definir Coordenadas

No arquivo `coordinates.py`:

```python
CNH_COORDINATES = {
    # ... campos existentes
    "novo_campo": (x, y),  # Substitua x, y pelas coordenadas desejadas
}
```

### 2. Definir Configura√ß√£o de Fonte

```python
FONT_CONFIGS = {
    # ... configura√ß√µes existentes
    "novo_campo": {"size": 12, "color": (0, 0, 0), "bold": False},
}
```

### 3. Implementar no Gerador

No m√©todo `_apply_data_with_coordinates`:

```python
# Novo campo
novo_valor = cnh_request.novo_campo or "VALOR_PADR√ÉO"
draw_field_if_exists("novo_campo", novo_valor)
```

## üîç Debugging e Testes

### Logs de Debug

O sistema inclui logs detalhados:

```python
logger.debug(f"Campo '{field_name}' desenhado: '{text}' em {coord}")
logger.debug(f"N√∫mero habilita√ß√£o vertical '{numero_text}' desenhado em {position}")
```

### Teste de Coordenadas

Para testar novas coordenadas:

```python
def test_coordenadas():
    img = Image.new('RGB', (700, 440), (255, 255, 255))
    draw = ImageDraw.Draw(img)
    
    # Desenha ret√¢ngulo na posi√ß√£o de teste
    x, y = (100, 200)  # Coordenadas a testar
    draw.rectangle([x, y, x + 50, y + 20], outline=(255, 0, 0), width=2)
    
    # Desenha texto
    draw.text((x, y), "TESTE", font=font, fill=(0, 0, 0))
    
    img.save("teste_coordenadas.png")
```

## üìä Estrutura de Arquivos

```
claude/
‚îú‚îÄ‚îÄ static/
‚îÇ   ‚îú‚îÄ‚îÄ cnh_matriz/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ coordinates.py      # ‚Üê Coordenadas e configura√ß√µes
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ front-cnh.png      # ‚Üê Template base da CNH
‚îÇ   ‚îú‚îÄ‚îÄ fonts/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Arvo-Bold.ttf      # ‚Üê Fonte principal bold
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Arvo-Regular.ttf   # ‚Üê Fonte principal regular
‚îÇ   ‚îî‚îÄ‚îÄ generated_cnhs/        # ‚Üê CNHs geradas
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ cnh_generator.py       # ‚Üê Gerador principal
‚îî‚îÄ‚îÄ models/
    ‚îî‚îÄ‚îÄ cnh_request.py         # ‚Üê Modelo de dados
```

## üéì Conceitos Importantes

### 1. Sistema de Coordenadas PIL

- **Origem (0,0)**: Canto superior esquerdo
- **Eixo X**: Da esquerda para direita
- **Eixo Y**: De cima para baixo

### 2. Transpar√™ncia RGBA

- **RGB**: Cor (Red, Green, Blue)
- **A**: Alpha (transpar√™ncia)
- `(255, 255, 255, 0)` = Branco transparente

### 3. Rota√ß√£o de Imagens

```python
rotated = img.rotate(90, expand=True)
```
- `expand=True`: Expande a imagem para caber o conte√∫do rotacionado

### 4. M√°scaras de Transpar√™ncia

```python
main_image.paste(temp_img, (x, y), temp_img)
```
- O terceiro par√¢metro usa a pr√≥pria imagem como m√°scara

## üöÄ Otimiza√ß√µes e Boas Pr√°ticas

### 1. Cache de Fontes

As fontes s√£o carregadas uma vez e reutilizadas:

```python
def _load_fonts(self):
    self.title_font = self._get_font(24)
    self.header_font = self._get_font(32)
    self.data_font = self._get_font(18)
    self.small_font = self._get_font(14)
```

### 2. Fallbacks Robustos

Sempre ter fallbacks para casos de erro:

```python
try:
    # Opera√ß√£o principal
    complex_operation()
except Exception as e:
    logger.error(f"Erro: {e}")
    # Fallback simples
    simple_fallback()
```

### 3. Valida√ß√£o de Dados

```python
def draw_field_if_exists(field_name, text):
    if text and field_name in CNH_COORDINATES and field_name in FONT_CONFIGS:
        # Desenha apenas se tudo estiver v√°lido
        draw_text()
```

## üîß Troubleshooting

### Problema: Texto Cortado

**Causa**: Dimens√µes da imagem tempor√°ria insuficientes
**Solu√ß√£o**: Aumentar margem na cria√ß√£o da imagem tempor√°ria

### Problema: Fonte N√£o Encontrada

**Causa**: Arquivo de fonte n√£o existe
**Solu√ß√£o**: Verificar hierarquia de fallbacks

### Problema: Posicionamento Incorreto

**Causa**: Coordenadas n√£o calibradas com template
**Solu√ß√£o**: Usar ferramenta de medi√ß√£o para verificar posi√ß√µes

---

## üìö Refer√™ncias

- [PIL/Pillow Documentation](https://pillow.readthedocs.io/)
- [ImageDraw Reference](https://pillow.readthedocs.io/en/stable/reference/ImageDraw.html)
- [Especifica√ß√µes CNH DENATRAN](https://www.gov.br/infraestrutura/pt-br/assuntos/transito/conteudo-denatran)

---

*Esta documenta√ß√£o foi criada para facilitar o entendimento e manuten√ß√£o do sistema de gera√ß√£o de CNH. Para d√∫vidas ou sugest√µes, consulte o c√≥digo-fonte ou entre em contato com a equipe de desenvolvimento.* 