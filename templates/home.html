<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Page</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        #particles-js {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .content-wrapper {
            position: relative;
            z-index: 2;
        }

        .bg-gradient {
            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 50%, #4f46e5 100%);
            animation: gradientAnimation 15s ease infinite;
            background-size: 400% 400%;
        }

        @keyframes gradientAnimation {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .glass-card {
            background: rgba(17, 24, 39, 0.7);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.45);
        }

        .menu-item {
            transition: all 0.3s ease;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .balance-card {
            background: linear-gradient(45deg, #0ea5e9, #2563eb);
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
        }

        .balance-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: cardShine 3s infinite;
        }

        @keyframes cardShine {
            0% {
                transform: translateX(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(100%) rotate(45deg);
            }
        }

        .profile-dropdown {
            opacity: 0;
            transform: translateY(-10px);
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 50;
        }

        .profile-trigger:hover .profile-dropdown {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient overflow-x-hidden overflow-y-auto">
    <div id="particles-js"></div>
    
    <div class="content-wrapper min-h-screen overflow-x-hidden overflow-y-auto">
        <!-- Header -->
        <header class="relative z-20 glass-card p-4">
            <div class="container mx-auto">
                <div class="flex items-center justify-between">
                    <!-- Logo -->
                    <div class="text-white text-2xl font-bold">
                        Logo
                    </div>

                    <!-- User Info & Balance -->
                    <div class="flex items-center space-x-6">
                        <!-- Balance Card -->
                        <div class="balance-card rounded-lg p-3 relative group">
                            <div class="flex items-center gap-3">
                                <div class="w-7 h-7 rounded-md bg-white/10 flex items-center justify-center">
                                    <i class="fas fa-wallet text-white text-sm"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center justify-between">
                                        <p class="text-xs text-white/70">Saldo Dispon√≠vel</p>
                                        <button onclick="toggleBalance()" class="opacity-0 group-hover:opacity-100 transition-opacity">
                                            <i id="eyeIcon" class="fas fa-eye text-white/60 hover:text-white text-xs transition-colors"></i>
                                        </button>
                                    </div>
                                    <div class="flex items-baseline gap-1 mt-0.5">
                                        <span class="text-xs text-white/60">R$</span>
                                        <p id="balanceAmount" class="text-lg font-bold text-white">{{ user_credits.formatted if user_credits else '0,00' }}</p>
                                        <p id="balanceHidden" class="text-lg font-bold text-white hidden">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</p>
                                        <span class="text-xs text-emerald-400 ml-1">
                                            {% if user_credits and user_credits.balance > 0 %}+{{ user_credits.balance }}{% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- User Profile -->
                        <div class="profile-trigger relative">
                            <div class="flex items-center space-x-3 cursor-pointer">
                                <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center">
                                    <i class="fas fa-user text-white"></i>
                                </div>
                                <div>
                                    <p class="text-white font-medium">{{ username or 'Usu√°rio' }}</p>
                                    <p class="text-white/60 text-sm">Premium</p>
                                </div>
                                <i class="fas fa-chevron-down text-white/60"></i>
                            </div>

                            <!-- Dropdown Menu -->
                            <div class="profile-dropdown absolute right-0 mt-2 w-48 glass-card rounded-xl">
                                <div class="py-2">
                                    <a href="#" class="menu-item block px-4 py-2 text-white hover:text-white/90">
                                        <i class="fas fa-user-circle mr-2"></i> Perfil
                                    </a>
                                    <a href="#" class="menu-item block px-4 py-2 text-white hover:text-white/90">
                                        <i class="fas fa-cog mr-2"></i> Configura√ß√µes
                                    </a>
                                    <a href="#" class="menu-item block px-4 py-2 text-white hover:text-white/90">
                                        <i class="fas fa-sign-out-alt mr-2"></i> Sair
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Quick Actions -->
                <div class="glass-card rounded-xl p-6 space-y-4">
                    <h2 class="text-xl font-bold text-white">A√ß√µes R√°pidas</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button class="menu-item p-4 rounded-lg bg-white/5 text-white text-center">
                            <i class="fas fa-exchange-alt mb-2"></i>
                            <p>Transferir</p>
                        </button>
                        <button class="menu-item p-4 rounded-lg bg-white/5 text-white text-center">
                            <i class="fas fa-qrcode mb-2"></i>
                            <p>Pix</p>
                        </button>
                        <button class="menu-item p-4 rounded-lg bg-white/5 text-white text-center">
                            <i class="fas fa-file-invoice-dollar mb-2"></i>
                            <p>Pagar</p>
                        </button>
                        <button onclick="showCNHSection()" class="menu-item p-4 rounded-lg bg-white/5 text-white text-center">
                            <i class="fas fa-id-card mb-2"></i>
                            <p>Gerar CNH</p>
                        </button>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="glass-card rounded-xl p-6">
                    <h2 class="text-xl font-bold text-white mb-4">Transa√ß√µes Recentes</h2>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full bg-green-500/10 flex items-center justify-center">
                                    <i class="fas fa-arrow-down text-green-500"></i>
                                </div>
                                <div>
                                    <p class="text-white">Recebido de Maria</p>
                                    <p class="text-white/60 text-sm">Hoje, 14:30</p>
                                </div>
                            </div>
                            <p class="text-green-500 font-medium">+ R$ 150,00</p>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full bg-red-500/10 flex items-center justify-center">
                                    <i class="fas fa-arrow-up text-red-500"></i>
                                </div>
                                <div>
                                    <p class="text-white">Pagamento Netflix</p>
                                    <p class="text-white/60 text-sm">Ontem, 09:15</p>
                                </div>
                            </div>
                            <p class="text-red-500 font-medium">- R$ 39,90</p>
                        </div>
                    </div>
                </div>

                <!-- Upcoming Bills -->
                <div class="glass-card rounded-xl p-6">
                    <h2 class="text-xl font-bold text-white mb-4">Pr√≥ximas Faturas</h2>
                    <div class="space-y-4">
                        <div class="p-4 bg-white/5 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-white">Cart√£o de Cr√©dito</p>
                                <p class="text-white font-medium">R$ 1.250,00</p>
                            </div>
                            <div class="w-full bg-white/10 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 70%"></div>
                            </div>
                            <p class="text-white/60 text-sm mt-2">Vence em 5 dias</p>
                        </div>
                        <div class="p-4 bg-white/5 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-white">Internet</p>
                                <p class="text-white font-medium">R$ 99,90</p>
                            </div>
                            <div class="w-full bg-white/10 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 30%"></div>
                            </div>
                            <p class="text-white/60 text-sm mt-2">Vence em 15 dias</p>
                        </div>
                    </div>
                </div>

                <!-- CNH Management Section -->
                <div id="cnhSection" class="hidden mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- CNH Generator -->
                    <div class="glass-card rounded-xl p-6">
                        <h2 class="text-xl font-bold text-white mb-4">
                            <i class="fas fa-id-card mr-2"></i>
                            Gerar Nova CNH
                        </h2>
                        <form id="cnhForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-white/80 text-sm mb-2">Nome Completo</label>
                                    <input type="text" id="nomeCompleto" name="nome_completo" required
                                           class="w-full p-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:border-blue-400 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-white/80 text-sm mb-2">CPF</label>
                                    <input type="text" id="cpf" name="cpf" required placeholder="000.000.000-00"
                                           class="w-full p-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:border-blue-400 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-white/80 text-sm mb-2">RG</label>
                                    <input type="text" id="rg" name="rg" required
                                           class="w-full p-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:border-blue-400 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-white/80 text-sm mb-2">Data de Nascimento</label>
                                    <input type="date" id="dataNascimento" name="data_nascimento" required
                                           class="w-full p-3 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-400 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-white/80 text-sm mb-2">Categoria</label>
                                    <select id="categoria" name="categoria"
                                            class="w-full p-3 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-400 focus:outline-none">
                                        <option value="B" selected>B - Carro</option>
                                        <option value="A">A - Moto</option>
                                        <option value="C">C - Caminh√£o</option>
                                        <option value="D">D - √înibus</option>
                                        <option value="E">E - Carreta</option>
                                        <option value="AB">AB - Carro + Moto</option>
                                        <option value="AC">AC - Carro + Caminh√£o</option>
                                        <option value="AD">AD - Carro + √înibus</option>
                                        <option value="AE">AE - Todas</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-white font-medium">Custo da CNH</p>
                                        <p class="text-white/60 text-sm">Ser√° debitado do seu saldo</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-2xl font-bold text-blue-400">R$ 5,00</p>
                                        <p class="text-white/60 text-sm">Saldo: R$ {{ user_credits.formatted if user_credits else '0,00' }}</p>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" id="generateCNHBtn" 
                                    class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105">
                                <i class="fas fa-magic mr-2"></i>
                                Gerar CNH por R$ 5,00
                            </button>
                        </form>

                        <!-- Generation Status -->
                        <div id="generationStatus" class="hidden mt-4 p-4 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div id="statusIcon" class="w-8 h-8 rounded-full flex items-center justify-center">
                                    <i class="fas fa-spinner fa-spin text-white"></i>
                                </div>
                                <div>
                                    <p id="statusText" class="text-white font-medium">Processando...</p>
                                    <p id="statusDetail" class="text-white/60 text-sm">Gerando sua CNH...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- My CNHs -->
                    <div class="glass-card rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold text-white">
                                <i class="fas fa-list mr-2"></i>
                                Minhas CNHs
                            </h2>
                            <button onclick="loadMyCNHs()" class="text-blue-400 hover:text-blue-300 transition-colors">
                                <i class="fas fa-refresh"></i>
                            </button>
                        </div>
                        
                        <div id="cnhsList" class="space-y-3">
                            <div class="text-center py-8 text-white/60">
                                <i class="fas fa-id-card text-4xl mb-3 opacity-50"></i>
                                <p>Carregando suas CNHs...</p>
                            </div>
                        </div>

                        <!-- Quick Stats -->
                        <div class="mt-6 grid grid-cols-3 gap-4">
                            <div class="bg-white/5 rounded-lg p-3 text-center">
                                <p id="totalCNHs" class="text-2xl font-bold text-blue-400">-</p>
                                <p class="text-white/60 text-xs">Total</p>
                            </div>
                            <div class="bg-white/5 rounded-lg p-3 text-center">
                                <p id="completedCNHs" class="text-2xl font-bold text-green-400">-</p>
                                <p class="text-white/60 text-xs">Conclu√≠das</p>
                            </div>
                            <div class="bg-white/5 rounded-lg p-3 text-center">
                                <p id="todayCNHs" class="text-2xl font-bold text-yellow-400">-</p>
                                <p class="text-white/60 text-xs">Hoje</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        particlesJS('particles-js',
        {
            "particles": {
                "number": {
                    "value": 80,
                    "density": {
                        "enable": true,
                        "value_area": 800
                    }
                },
                "color": {
                    "value": "#ffffff"
                },
                "shape": {
                    "type": "circle"
                },
                "opacity": {
                    "value": 0.5,
                    "random": true
                },
                "size": {
                    "value": 3,
                    "random": true
                },
                "line_linked": {
                    "enable": true,
                    "distance": 150,
                    "color": "#ffffff",
                    "opacity": 0.4,
                    "width": 1
                },
                "move": {
                    "enable": true,
                    "speed": 2,
                    "direction": "none",
                    "random": true,
                    "straight": false,
                    "out_mode": "out",
                    "bounce": false
                }
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": {
                    "onhover": {
                        "enable": true,
                        "mode": "grab"
                    },
                    "onclick": {
                        "enable": true,
                        "mode": "push"
                    },
                    "resize": true
                }
            },
            "retina_detect": true
        });

        // Balance visibility toggle
        function toggleBalance() {
            const balanceAmount = document.getElementById('balanceAmount');
            const balanceHidden = document.getElementById('balanceHidden');
            const eyeIcon = document.getElementById('eyeIcon');

            if (balanceAmount.classList.contains('hidden')) {
                balanceAmount.classList.remove('hidden');
                balanceHidden.classList.add('hidden');
                eyeIcon.classList.remove('fa-eye-slash');
                eyeIcon.classList.add('fa-eye');
            } else {
                balanceAmount.classList.add('hidden');
                balanceHidden.classList.remove('hidden');
                eyeIcon.classList.remove('fa-eye');
                eyeIcon.classList.add('fa-eye-slash');
            }
        }

        // CNH Section Management
        function showCNHSection() {
            console.log('üÜî Abrindo se√ß√£o CNH...');
            const cnhSection = document.getElementById('cnhSection');
            if (cnhSection.classList.contains('hidden')) {
                cnhSection.classList.remove('hidden');
                cnhSection.scrollIntoView({ behavior: 'smooth' });
                console.log('üìã Carregando CNHs do usu√°rio...');
                loadMyCNHs(); // Load user's CNHs when section opens
            } else {
                cnhSection.classList.add('hidden');
            }
        }

        // CPF Formatting
        function formatCPF(value) {
            return value
                .replace(/\D/g, '')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d{1,2})/, '$1-$2')
                .replace(/(-\d{2})\d+?$/, '$1');
        }

        // Form validation
        function validateCNHForm(formData) {
            const errors = [];
            
            if (!formData.nome_completo || formData.nome_completo.length < 10) {
                errors.push('Nome deve ter pelo menos 10 caracteres');
            }
            
            if (!formData.cpf || formData.cpf.replace(/\D/g, '').length !== 11) {
                errors.push('CPF deve ter 11 d√≠gitos');
            }
            
            if (!formData.rg || formData.rg.length < 4) {
                errors.push('RG deve ter pelo menos 4 caracteres');
            }
            
            if (!formData.data_nascimento) {
                errors.push('Data de nascimento √© obrigat√≥ria');
            } else {
                const birthDate = new Date(formData.data_nascimento);
                const today = new Date();
                const age = today.getFullYear() - birthDate.getFullYear();
                
                if (age < 18 || age > 80) {
                    errors.push('Idade deve estar entre 18 e 80 anos');
                }
            }
            
            return errors;
        }

        // Show generation status
        function showGenerationStatus(type, title, message) {
            const statusDiv = document.getElementById('generationStatus');
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const statusDetail = document.getElementById('statusDetail');
            
            statusDiv.classList.remove('hidden', 'bg-green-500/10', 'bg-red-500/10', 'bg-blue-500/10');
            
            switch(type) {
                case 'processing':
                    statusDiv.classList.add('bg-blue-500/10');
                    statusIcon.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-400"></i>';
                    break;
                case 'success':
                    statusDiv.classList.add('bg-green-500/10');
                    statusIcon.innerHTML = '<i class="fas fa-check text-green-400"></i>';
                    break;
                case 'error':
                    statusDiv.classList.add('bg-red-500/10');
                    statusIcon.innerHTML = '<i class="fas fa-exclamation-triangle text-red-400"></i>';
                    break;
            }
            
            statusText.textContent = title;
            statusDetail.textContent = message;
        }

        // Generate CNH
        async function generateCNH(formData) {
            try {
                const response = await fetch('/api/cnh/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    return { success: true, data: result };
                } else {
                    return { success: false, error: result.error || 'Erro desconhecido' };
                }
            } catch (error) {
                return { success: false, error: 'Erro de conex√£o: ' + error.message };
            }
        }

        // Load user's CNHs
        async function loadMyCNHs() {
            try {
                console.log('üîÑ Carregando CNHs...');
                const response = await fetch('/api/cnh/my-cnhs', {
                    method: 'GET',
                    credentials: 'same-origin', // Inclui cookies de sess√£o
                    headers: {
                        'Cache-Control': 'no-cache' // Force refresh
                    }
                });
                
                console.log('üì° Response status:', response.status);
                const result = await response.json();
                console.log('üìä API result:', result);
                
                if (response.ok) {
                    displayCNHs(result.cnhs);
                    updateCNHStats(result.stats);
                    console.log(`‚úÖ Carregadas ${result.cnhs.length} CNHs`);
                } else {
                    console.error('‚ùå Erro ao carregar CNHs:', result.error);
                    // Tentar recarregar p√°gina se n√£o autenticado
                    if (response.status === 401) {
                        console.log('üîí N√£o autenticado, redirecionando...');
                        window.location.href = '/';
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro de conex√£o:', error);
            }
        }

        // Display CNHs in the list
        function displayCNHs(cnhs) {
            const cnhsList = document.getElementById('cnhsList');
            
            if (!cnhs || cnhs.length === 0) {
                cnhsList.innerHTML = `
                    <div class="text-center py-8 text-white/60">
                        <i class="fas fa-id-card text-4xl mb-3 opacity-50"></i>
                        <p>Voc√™ ainda n√£o gerou nenhuma CNH</p>
                        <p class="text-sm mt-1">Preencha o formul√°rio ao lado para come√ßar</p>
                    </div>
                `;
                return;
            }
            
            cnhsList.innerHTML = cnhs.map(cnh => `
                <div class="bg-white/5 rounded-lg p-4 hover:bg-white/10 transition-colors">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center">
                                    <i class="fas fa-id-card text-blue-400"></i>
                                </div>
                                <div>
                                    <p class="text-white font-medium">${cnh.nome_completo}</p>
                                    <p class="text-white/60 text-sm">CPF: ${cnh.cpf} ‚Ä¢ Cat: ${cnh.categoria}</p>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 text-xs rounded-full ${getStatusClass(cnh.status)}">
                                    ${cnh.status_display}
                                </span>
                                ${cnh.can_download ? `
                                    <button onclick="downloadCNH('${cnh.id}')" 
                                            class="p-2 bg-green-500/20 text-green-400 rounded-lg hover:bg-green-500/30 transition-colors">
                                        <i class="fas fa-download text-sm"></i>
                                    </button>
                                ` : ''}
                            </div>
                            <p class="text-white/40 text-xs mt-1">
                                ${new Date(cnh.created_at).toLocaleDateString('pt-BR')}
                            </p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Get CSS class for status
        function getStatusClass(status) {
            switch(status) {
                case 'completed':
                    return 'bg-green-500/20 text-green-400';
                case 'processing':
                    return 'bg-blue-500/20 text-blue-400';
                case 'failed':
                    return 'bg-red-500/20 text-red-400';
                default:
                    return 'bg-yellow-500/20 text-yellow-400';
            }
        }

        // Update CNH statistics
        function updateCNHStats(stats) {
            document.getElementById('totalCNHs').textContent = stats.total || 0;
            document.getElementById('completedCNHs').textContent = stats.completed || 0;
            document.getElementById('todayCNHs').textContent = stats.today || 0;
        }

        // Download CNH
        function downloadCNH(cnhId) {
            window.open(`/api/cnh/download/${cnhId}`, '_blank');
        }

        // Update user balance without page reload
        async function updateUserBalance() {
            try {
                console.log('üí∞ Atualizando saldo do usu√°rio...');
                const response = await fetch('/api/user/balance', {
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const balanceElement = document.querySelector('.credit-value');
                    if (balanceElement) {
                        balanceElement.textContent = data.formatted || 'R$ 0,00';
                        console.log(`üí∞ Saldo atualizado: ${data.formatted}`);
                    }
                } else {
                    console.log('‚ö†Ô∏è N√£o foi poss√≠vel atualizar saldo, mas continuando...');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Erro ao atualizar saldo:', error);
            }
        }

        // Auto-refresh CNHs periodically (mais suave)
        function startAutoRefresh() {
            console.log('üîÑ Iniciando auto-refresh de CNHs...');
            
            // Refresh every 15 seconds if CNH section is visible (reduzido frequ√™ncia)
            setInterval(() => {
                const cnhSection = document.getElementById('cnhSection');
                if (cnhSection && !cnhSection.classList.contains('hidden')) {
                    console.log('üîÑ Auto-refresh CNHs...');
                    loadMyCNHs();
                }
            }, 15000); // Aumentado de 10s para 15s
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ P√°gina carregada, inicializando...');
            
            // Start auto-refresh
            startAutoRefresh();
            
            // CPF input formatting
            const cpfInput = document.getElementById('cpf');
            if (cpfInput) {
                cpfInput.addEventListener('input', function(e) {
                    e.target.value = formatCPF(e.target.value);
                });
            }

            // CNH Form submission
            const cnhForm = document.getElementById('cnhForm');
            if (cnhForm) {
                cnhForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Get form data
                    const formData = new FormData(cnhForm);
                    const cnhData = Object.fromEntries(formData.entries());
                    
                    // Validate form
                    const errors = validateCNHForm(cnhData);
                    if (errors.length > 0) {
                        showGenerationStatus('error', 'Dados inv√°lidos', errors[0]);
                        return;
                    }
                    
                    // Disable form and show processing
                    const submitBtn = document.getElementById('generateCNHBtn');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Gerando...';
                    
                    showGenerationStatus('processing', 'Processando', 'Validando dados e gerando CNH...');
                    
                    // Generate CNH
                    const result = await generateCNH(cnhData);
                    
                    // Re-enable form
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-magic mr-2"></i>Gerar CNH por R$ 5,00';
                    
                                         if (result.success) {
                         showGenerationStatus('success', 'CNH Gerada!', 
                             `CNH #${result.data.cnh.id} criada com sucesso. Aguardando processamento...`);
                         
                         // Clear form
                         cnhForm.reset();
                         
                         // Immediate reload to show new CNH
                         loadMyCNHs();
                         
                         // Setup polling for status updates
                         const cnhId = result.data.cnh.id;
                         console.log(`üîÑ Iniciando polling para CNH #${cnhId}`);
                         
                         const pollInterval = setInterval(async () => {
                             console.log(`üì° Polling CNH #${cnhId}...`);
                             
                             // Reload list
                             await loadMyCNHs();
                             
                             // Check if CNH is completed
                             try {
                                 const statusResponse = await fetch(`/api/cnh/status/${cnhId}`, {
                                     credentials: 'same-origin'
                                 });
                                 
                                 if (statusResponse.ok) {
                                     const statusData = await statusResponse.json();
                                     const cnh = statusData.cnh;
                                     
                                     console.log(`üìä CNH #${cnhId} status:`, cnh.status);
                                     
                                     if (cnh.status === 'completed') {
                                         console.log(`‚úÖ CNH #${cnhId} completa!`);
                                         clearInterval(pollInterval);
                                         
                                         // Final reload da lista e atualizar saldo
                                         await loadMyCNHs();
                                         await updateUserBalance();
                                         
                                         // Hide status after success
                                         setTimeout(() => {
                                             document.getElementById('generationStatus').classList.add('hidden');
                                         }, 3000);
                                         
                                     } else if (cnh.status === 'failed') {
                                         console.log(`‚ùå CNH #${cnhId} falhou:`, cnh.error_message);
                                         clearInterval(pollInterval);
                                         showGenerationStatus('error', 'Falha na gera√ß√£o', cnh.error_message || 'Erro desconhecido');
                                     }
                                 }
                             } catch (pollError) {
                                 console.error('‚ùå Erro no polling:', pollError);
                             }
                         }, 2000); // Poll every 2 seconds
                         
                         // Stop polling after 20 seconds (sistema tem timeout de 15s)
                         setTimeout(() => {
                             console.log('‚è∞ Timeout do polling - sistema deve ter processado automaticamente');
                             clearInterval(pollInterval);
                             
                             // For√ßa uma √∫ltima verifica√ß√£o
                             loadMyCNHs();
                         }, 20000);
                         
                     } else {
                         showGenerationStatus('error', 'Erro na gera√ß√£o', result.error);
                     }
                });
            }
        });
    </script>
</body>
</html> 